<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>How to backup and analyse iOS devices against Pegasus IOCs using Docker and MVT</title><link rel=stylesheet href=../../../css/main.min.5989377ad0360ceee48513008c4879d87f2d0629b59bdc574c70dd602c708b7d5f587d43270ee97f4221f994cc954a2c54aef4552dca426bbfcc55120d557d60.css integrity="sha512-WYk3etA2DO7khRMAjEh52H8tBim1m9xXTHDdYCxwi31fWH1DJw7pf0Ih+ZTMlUosVK70VS3KQmu/zFUSDVV9YA=="><link rel=stylesheet href=../../../css/animate.min.min.4872c1d4de66cc3ac01c85a7e466d119025c7aa62b5b7733169ff45fc7a8b1affba6897a19d1b85abf449ca58dbb1c1852bff9263266de0d3067d6a871176868.css integrity="sha512-SHLB1N5mzDrAHIWn5GbRGQJceqYrW3czFp/0X8eosa/7pol6GdG4Wr9EnKWNuxwYUr/5JjJm3g0wZ9aocRdoaA=="><link rel=stylesheet href=../../../css/syntax.min.130737faaadcf2d7538b6e5196785287c7b3475c2f79d189bf16810b0e86628f9b7b8575a2bb430691650517d300934a2808e79a220aa09f7d29add7a352d8d0.css integrity="sha512-Ewc3+qrc8tdTi25RlnhSh8ezR1wvedGJvxaBCw6GYo+be4V1ortDBpFlBRfTAJNKKAjnmiIKoJ99Ka3Xo1LY0A=="><link rel=icon type=image/png href=../../../images/favicon.png><link rel=canonical href=../../../2021/07/pegasus-ios-forensic/><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Defensive Lab Agency"><meta name=description content="This guide gives you a step-by-step procedure to conduct forensic analysis of an iOS device using Mobile Verification Toolkit (MVT) created by Amnesty Tech team.
This guide is written and maintained by Esther Onfroy & Abir Ghattas.
Why? People are struggling to analyze iOS devices due to the complexity of the procedure on Linux. We have decided to use Docker because latest versions of iOS require the use of a version of libimobiledevice which is not available on Linux yet."><meta property="og:title" content="How to backup and analyse iOS devices against Pegasus IOCs using Docker and MVT"><meta property="og:description" content="This guide gives you a step-by-step procedure to conduct forensic analysis of an iOS device using Mobile Verification Toolkit (MVT) created by Amnesty Tech team.
This guide is written and maintained by Esther Onfroy & Abir Ghattas.
Why? People are struggling to analyze iOS devices due to the complexity of the procedure on Linux. We have decided to use Docker because latest versions of iOS require the use of a version of libimobiledevice which is not available on Linux yet."><meta property="og:type" content="article"><meta property="og:url" content="/2021/07/pegasus-ios-forensic/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-07-23T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to backup and analyse iOS devices against Pegasus IOCs using Docker and MVT"><meta name=twitter:description content="This guide gives you a step-by-step procedure to conduct forensic analysis of an iOS device using Mobile Verification Toolkit (MVT) created by Amnesty Tech team.
This guide is written and maintained by Esther Onfroy & Abir Ghattas.
Why? People are struggling to analyze iOS devices due to the complexity of the procedure on Linux. We have decided to use Docker because latest versions of iOS require the use of a version of libimobiledevice which is not available on Linux yet."></head><body><nav class="navbar is-transparent no-shadow" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=../../../><img src=../../../images/logos/logo_without_text.svg alt width=52px height=52px> Defensive Lab Agency</a>
<a role=button class=navbar-burger aria-label=menu aria-expanded=false data-target=navbar-menu><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=navbar-menu class="navbar-menu is-static"><div class=navbar-end><a href=../../../#solutions id=solutionsLink class="navbar-item is-secondary">Solutions</a>
<a href=../../../#products id=productsLink class="navbar-item is-secondary">Products</a>
<a href=../../../#services id=servicesLink class="navbar-item is-secondary">Services</a>
<a href=../../../post/ class="navbar-item is-secondary">Blog</a>
<a href=mailto:contact@defensive-lab.agency class=navbar-item><span class="button is-primary is-rounded">Contact us</span></a></div></div></div></nav><section><section class='hero is-small is-fullwidth'><div class=hero-body><div class=container><h1 class=title>How to backup and analyse iOS devices against Pegasus IOCs using Docker and MVT</h1><h2 class=subtitle><time datetime=2021-07-23T00:00:00Z>July 23, 2021</time><br><a class="tag has-background-primary is-link" href=../../../tags/mobile/>Mobile</a>
<a class="tag has-background-primary is-link" href=../../../tags/forensic/>Forensic</a>
<a class="tag has-background-primary is-link" href=../../../tags/pegasus/>Pegasus</a>
<a class="tag has-background-primary is-link" href=../../../tags/ios/>iOS</a></h2></div></div></section><section class=section><div class=container><div class=content><p>This guide gives you a step-by-step procedure to conduct forensic analysis of an iOS device using <a href=https://github.com/mvt-project/mvt>Mobile Verification Toolkit (MVT)</a> created by Amnesty Tech team.</p><p>This guide is written and maintained by <a href=https://twitter.com/U039b>Esther Onfroy</a> & <a href=https://twitter.com/abirghattas>Abir Ghattas</a>.</p><h2 id=why>Why?</h2><p>People are struggling to analyze iOS devices due to the complexity of the procedure on Linux. We have decided to use Docker because latest versions of iOS require the use of a version of <code>libimobiledevice</code> which is not available on Linux yet. We use <code>libimobiledevice</code> to backup the iOS device instead of using iTunes.</p><p>This guide has been successfully tested on Ubuntu 20.04 with:</p><ul><li>iOS 13.5.1</li><li>iOS 14.5</li><li>iOS 14.7</li></ul><h2 id=requirements>Requirements</h2><ul><li>A Debian-based operating system</li><li>A root access on your computer</li><li><a href=https://docs.docker.com/engine/install/>Docker</a> already installed</li><li><strong>Knowledge in Linux command-line</strong></li></ul><p>Follow each step in the same terminal session.</p><h2 id=prepare-your-computer>Prepare your computer</h2><h5 id=1-create-a-directory-for-your-investigations>1. Create a directory for your investigations</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir Pegasus_investigations
</span></span><span class=line><span class=cl><span class=nb>cd</span> Pegasus_investigations
</span></span></code></pre></td></tr></table></div></div><h5 id=2-prepare-directory-structure>2. Prepare directory structure</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir ioc backup decrypted checked
</span></span></code></pre></td></tr></table></div></div><h5 id=3-retrieve-ioc-provided-by-amnesty-international>3. Retrieve IOC provided by Amnesty International</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://raw.githubusercontent.com/AmnestyTech/investigations/master/2021-07-18_nso/pegasus.stix2 -O ioc/pegasus.stix2
</span></span></code></pre></td></tr></table></div></div><p>If you want to learn more about the IOC, check <a href=https://github.com/AmnestyTech/investigations/tree/master/2021-07-18_nso>the Amnesty Tech repository</a>.</p><h5 id=4-retrieve-the-dockerfile>4. Retrieve the Dockerfile</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://raw.githubusercontent.com/mvt-project/mvt/main/Dockerfile -O Dockerfile
</span></span></code></pre></td></tr></table></div></div><h5 id=5-build-the-docker-image>5. Build the Docker image</h5><p>Depending on you setup, we would have to be root from this step to the end of the investigation.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t mvt .
</span></span></code></pre></td></tr></table></div></div><h2 id=prepare-the-ios-device-to-be-analyzed>Prepare the iOS device to be analyzed</h2><h5 id=6-plug-your-ios-device-to-your-computer>6. Plug your iOS device to your computer</h5><p>Do not unplug it until the end of the backup procedure and be sure to keep the device unlocked</p><h5 id=7-stop-the-usb-mixer>7. Stop the USB mixer</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl stop usbmuxd
</span></span></code></pre></td></tr></table></div></div><p>This command could take a bit of time, just wait.</p><h5 id=8-start-the-docker-container>8. Start the Docker container</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -it --privileged --rm -v /dev/bus/usb:/dev/bus/usb --net<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=nv>$PWD</span>/ioc:/home/cases/ioc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=nv>$PWD</span>/decrypted:/home/cases/decrypted <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=nv>$PWD</span>/checked:/home/cases/checked <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=nv>$PWD</span>/backup:/home/cases/backup <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  mvt
</span></span></code></pre></td></tr></table></div></div><p>Now any command you run will be executed inside the container.</p><h5 id=9-start-the-usb-mixer>9. Start the USB mixer</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>usbmuxd
</span></span></code></pre></td></tr></table></div></div><p>The iOS device may be asking you if you trust the connected computer, trust it.</p><h5 id=10-check-if-the-ios-is-recognized>10. Check if the iOS is recognized</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ideviceinfo
</span></span></code></pre></td></tr></table></div></div><h2 id=backup-the-ios-device>Backup the iOS device</h2><h5 id=11-turn-backup-encryption-on>11. Turn backup encryption on</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>idevicebackup2 backup encryption on -i
</span></span></code></pre></td></tr></table></div></div><h5 id=12-backup-the-ios-device>12. Backup the iOS device</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>idevicebackup2 backup --full backup/
</span></span></code></pre></td></tr></table></div></div><p>Once done, you can unplug the iOS device. Run <code>ls -l backup</code> to get the name of the backup.</p><h2 id=analyze-the-backup>Analyze the backup</h2><h5 id=13-decrypt-the-backup>13. Decrypt the backup</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mvt-ios decrypt-backup -p &lt;backup password&gt; -d decrypted backup/&lt;backup name&gt;
</span></span></code></pre></td></tr></table></div></div><p>For more details and options, check <a href=https://mvt.readthedocs.io/en/latest/ios/backup/check.html>the MVT documentation</a> and <a href=https://mvt.readthedocs.io/en/latest/ios/backup/libimobiledevice.html>the note regarding the backup password</a>.
If you have backed up this phone using iTunes, the <strong>backup password</strong> is the same as the one you provided in iTunes.</p><h5 id=14-analyze-the-backup>14. Analyze the backup</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mvt-ios check-backup -o checked --iocs ioc/pegasus.stix2 decrypted
</span></span></code></pre></td></tr></table></div></div><h5 id=15-check-the-results>15. Check the results</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls -l checked
</span></span></code></pre></td></tr></table></div></div><p>The folder <code>checked</code> contains <a href=https://mvt.readthedocs.io/en/latest/ios/records.html>several JSON files</a>.
<strong>Any IOC matches are stored in JSON files suffixed by <code>_detected</code>.</strong></p><h5 id=16-exit-the-container>16. Exit the container</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>exit</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=17-save-the-outputs>17. Save the outputs</h5><p>If you want to keep the files generated during the forensic procedure, backup the following folders:</p><ul><li><code>backup</code> containing the iOS backup</li><li><code>decrypted</code> containing the decrypted backup</li><li><code>checked</code> containing the results of MVT analysis</li></ul></div></div></section></section><footer class="footer has-text-centered"><div class=container><div class=columns><div class="column is-8-desktop is-offset-2-desktop"><p><strong class=has-text-weight-semibold>Defensive Lab Agency SAS</strong></p><p class=is-size-7>31 avenue de Ségur<br>75007 Paris</p></div></div></div></footer><script type=text/javascript src=../../../js/jquery.min.b37aa5e19777b4245b2b33806ccb8aa04a495135a4ca29cb9c6d723649218fca284836dc0325af839919efed6ae55081cd9d3ff6a9442e9654afe27a815dbabc.js integrity="sha512-s3ql4Zd3tCRbKzOAbMuKoEpJUTWkyinLnG1yNkkhj8ooSDbcAyWvg5kZ7+1q5VCBzZ0/9qlELpZUr+J6gV26vA=="></script>
<script type=text/javascript src=../../../js/main.min.c9559bf2e42660ce33f55649002a0f7f7ba6fe1332b98d88c1edcb39d1df95ae9f2c5b8719f9bd56a6f39669d0bbc826353abe73c6a54aeaedab12f31b8d15e4.js integrity="sha512-yVWb8uQmYM4z9VZJACoPf3um/hMyuY2Iwe3LOdHfla6fLFuHGfm9VqbzlmnQu8gmNTq+c8alSurtqxLzG40V5A=="></script>
<script type=text/javascript src=../../../js/matomo.min.99dc8661ace843f4fa75e17b5e8f488da195636254c8ea01fb5759f22c05372d79e5f0856c2b5b69c5733bf1e75a3a949823f1b2040d7951aa6bb4e6b38066ca.js integrity="sha512-mdyGYazoQ/T6deF7Xo9IjaGVY2JUyOoB+1dZ8iwFNy155fCFbCtbacVzO/HnWjqUmCPxsgQNeVGqa7Tms4Bmyg=="></script></body></html>